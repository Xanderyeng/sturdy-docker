#!/bin/bash
config="$PWD/.global/docker-custom.yml"
compose="$PWD/.global/docker-compose.yml"

db_restores=`cat ${config} | shyaml get-value options.db_restores 2> /dev/null`

if [[ ${db_restores} != "False" ]]; then
  cd databases
  count=$(ls -1 *.sql 2>/dev/null | wc -l)

  if [[ count != 0 ]]; then
    for file in $( ls *.sql ); do
      database=${file%%.sql}
      running=`docker inspect -f '{{.State.Running}}' docker-mysql 2> /dev/null`

      if [[ ${running} == "true" ]]; then
          docker-compose -f ${compose} exec -T mysql mysql -u root -e "CREATE DATABASE IF NOT EXISTS ${database};"
          docker-compose -f ${compose} exec -T mysql mysql -u root -e "CREATE USER IF NOT EXISTS 'wordpress'@'%' IDENTIFIED WITH 'mysql_native_password' BY 'wordpress';"
          docker-compose -f ${compose} exec -T mysql mysql -u root -e "GRANT ALL PRIVILEGES ON ${database}.* to 'wordpress'@'%' WITH GRANT OPTION;"
          docker-compose -f ${compose} exec -T mysql mysql -u root -e "FLUSH PRIVILEGES;"

          exists=`docker-compose -f ${compose} exec -T mysql mysql -u root -e "SHOW TABLES FROM ${database};"`

          if [[ "" == ${exists} ]]; then
              docker-compose -f ${compose} exec -T mysql mysql -u root ${database} < ${database}.sql
          fi
      fi
    done
  fi
fi
